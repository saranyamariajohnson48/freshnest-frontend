import{d as _,r as a,j as t,e as D,h as k,i as M}from"./index-DWA34nyN.js";import l from"./chatService-Dmp2xPfZ.js";const R=n=>new Date(n).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),T=n=>{const i=new Date(n),c=new Date,s=(new Date(c.toDateString())-new Date(i.toDateString()))/864e5;return s===0?"Today":s===1?"Yesterday":i.toLocaleDateString()};function F(){const{user:n}=_(),[i,c]=a.useState(!0),[s,h]=a.useState(null),[g,p]=a.useState([]),[u,y]=a.useState(""),[S,v]=a.useState(!1),[x,w]=a.useState(!1),o=a.useRef(null),f=a.useRef(null),N=async()=>{c(!0);try{const{conversations:e}=await l.listConversations(),r=(e||[]).find(m=>(m.participants||[]).some(d=>["admin","Admin"].includes(d.role)));h(r||null)}catch(e){console.error(e)}finally{c(!1)}},b=async()=>{if(s)try{const{messages:e}=await l.getMessages(s._id,{limit:100});p(e||[]),await l.markAsRead(s._id),requestAnimationFrame(()=>o.current?.scrollTo({top:o.current.scrollHeight,behavior:"smooth"}))}catch(e){console.error(e)}};a.useEffect(()=>{N()},[]),a.useEffect(()=>{if(s)return b(),v(!0),f.current=setInterval(()=>b(),5e3),()=>{v(!1),f.current&&clearInterval(f.current)}},[s?._id]);const j=async()=>{if(!(!u.trim()||!s||x))try{w(!0);const{message:e}=await l.sendMessage(s._id,{text:u.trim()});y(""),p(r=>[...r,e]),await l.markAsRead(s._id),requestAnimationFrame(()=>o.current?.scrollTo({top:o.current.scrollHeight,behavior:"smooth"}))}catch(e){console.error(e)}finally{w(!1)}},A=a.useMemo(()=>{const e=[];let r="";return g.forEach(m=>{const d=T(m.createdAt);d!==r&&(e.push({type:"day",key:d}),r=d),e.push({type:"msg",data:m})}),e},[g]);return t.jsxs("div",{className:"bg-white border border-slate-200 rounded-2xl overflow-hidden",children:[t.jsxs("div",{className:"p-4 border-b bg-gradient-to-r from-emerald-50 to-white flex items-center gap-2",children:[t.jsx(D,{className:"w-5 h-5 text-emerald-600"}),t.jsx("div",{className:"font-semibold text-slate-900",children:"Messages with Admin"}),S&&t.jsx(k,{className:"w-4 h-4 ml-1 animate-spin text-slate-500"})]}),!s&&!i&&t.jsx("div",{className:"p-6 text-center text-slate-600",children:"No conversation with Admin yet. Please wait until Admin starts a conversation."}),i?t.jsx("div",{className:"p-6 text-center text-slate-500",children:"Loading..."}):s?t.jsxs(t.Fragment,{children:[t.jsx("div",{ref:o,className:"h-[55vh] overflow-y-auto p-4 space-y-2 bg-white",children:A.map((e,r)=>e.type==="day"?t.jsx("div",{className:"sticky top-0 z-10 flex justify-center my-2",children:t.jsx("span",{className:"text-[11px] font-medium text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200",children:e.key})},`d-${e.key}-${r}`):t.jsx("div",{className:`flex ${String(e.data.sender?._id||e.data.sender)===String(n?._id)?"justify-end":"justify-start"} px-1`,children:t.jsxs("div",{className:`max-w-[75%] rounded-2xl px-4 py-2 text-sm shadow ${String(e.data.sender?._id||e.data.sender)===String(n?._id)?"bg-emerald-600 text-white rounded-br-sm":"bg-gray-100 text-gray-900 rounded-bl-sm"}`,children:[e.data.text,t.jsx("div",{className:`text-[10px] mt-1 ${String(e.data.sender?._id||e.data.sender)===String(n?._id)?"text-white/80":"text-gray-500"}`,children:R(e.data.createdAt)})]})},e.data._id))}),t.jsx("div",{className:"p-3 border-t bg-white",children:t.jsxs("div",{className:"flex items-end gap-2",children:[t.jsx("textarea",{value:u,onChange:e=>y(e.target.value),onKeyDown:e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),j())},placeholder:"Type a message to Admin...",rows:1,className:"flex-1 resize-none border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"}),t.jsxs("button",{disabled:x,onClick:j,className:`px-4 py-2 rounded-lg inline-flex items-center space-x-2 ${x?"bg-emerald-400":"bg-emerald-600 hover:bg-emerald-700"} text-white`,children:[t.jsx(M,{className:"w-4 h-4"}),t.jsx("span",{children:"Send"})]})]})})]}):null]})}export{F as default};
