import{d as G,u as J,r as a,j as e,e as N,f as R,c as E,g as Q,h as V,i as X,s as Z,k as ee}from"./index-DWA34nyN.js";import d from"./chatService-Dmp2xPfZ.js";const se=l=>new Date(l).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),te=l=>{const i=new Date(l),m=new Date,o=(new Date(m.toDateString())-new Date(i.toDateString()))/864e5;return o===0?"Today":o===1?"Yesterday":i.toLocaleDateString()},U=({name:l="",role:i="",color:m="bg-emerald-600"})=>{const o=l.trim().split(" ").slice(0,2).map(v=>v[0]?.toUpperCase()).join("")||"U",x=i==="staff"?"bg-blue-100 text-blue-700":i==="supplier"?"bg-amber-100 text-amber-700":"bg-gray-100 text-gray-700";return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-9 h-9 rounded-full ${m} text-white grid place-items-center text-sm font-semibold`,children:o}),i&&e.jsx("span",{className:`text-[10px] px-2 py-0.5 rounded-full ${x}`,children:i})]})},ie=()=>{const{user:l}=G(),{error:i}=J(),[m,o]=a.useState(!0),[x,v]=a.useState([]),[n,w]=a.useState(null),[S,k]=a.useState([]),[C,_]=a.useState(""),[f,q]=a.useState(""),[z,A]=a.useState(!1),[y,D]=a.useState(!1),u=a.useRef(null),g=a.useRef(null),j=async()=>{try{o(!0);const{conversations:s}=await d.listConversations();v(s||[])}catch(s){console.error(s),i(s.message||"Failed to load conversations")}finally{o(!1)}},F=async s=>{try{const{messages:t}=await d.getMessages(s,{limit:100});k(t||[]),await d.markAsRead(s),requestAnimationFrame(()=>{g.current?.scrollTo({top:g.current.scrollHeight,behavior:"smooth"})})}catch(t){console.error(t)}};a.useEffect(()=>(j(),()=>{u.current&&clearInterval(u.current)}),[]),a.useEffect(()=>{if(n)return F(n._id),A(!0),u.current=setInterval(()=>{F(n._id)},5e3),()=>{A(!1),u.current&&clearInterval(u.current)}},[n?._id]);const L=async()=>{const s=C.trim();if(!(!s||!n||y))try{D(!0);const{message:t}=await d.sendMessage(n._id,{text:s});_(""),k(r=>[...r,t]),await d.markAsRead(n._id),await j(),requestAnimationFrame(()=>{g.current?.scrollTo({top:g.current.scrollHeight,behavior:"smooth"})})}catch(t){i(t.message||"Failed to send")}finally{D(!1)}},O=a.useMemo(()=>{if(!f)return x;const s=f.toLowerCase();return x.filter(t=>(t.participants||[]).filter(p=>String(p._id)!==String(l?._id)).map(p=>p.fullName||p.email).join(" ").toLowerCase().includes(s))},[f,x,l]),H=a.useMemo(()=>{const s=[];let t="";return S.forEach(r=>{const c=te(r.createdAt);c!==t&&(s.push({type:"day",key:c}),t=c),s.push({type:"msg",data:r})}),s},[S]),[I,b]=a.useState(!1),[T,K]=a.useState("staff"),[W,$]=a.useState([]),[Y,M]=a.useState(!1),h=async s=>{b(!0),K(s),M(!0);try{if(s==="staff"){const t=await Z.getAllStaff({limit:100});$(t?.data?.staff||t?.staff||[])}else{const t=await ee.getAllSuppliers({status:"active",limit:100,role:"supplier"});$(t?.users||[])}}catch(t){console.error(t),i("Failed to load list")}finally{M(!1)}},B=async s=>{try{const{conversation:t}=await d.startConversation(s);b(!1),await j(),w(t)}catch(t){i(t.message||"Failed to start conversation")}},P=s=>(s?.participants||[]).find(t=>String(t._id)!==String(l?._id));return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white rounded-2xl border border-gray-200 p-0 overflow-hidden lg:col-span-1",children:[e.jsxs("div",{className:"p-4 border-b bg-gradient-to-r from-emerald-50 to-white",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{className:"w-5 h-5 text-emerald-600"}),e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Messages"})]}),e.jsxs("div",{className:"space-x-2",children:[e.jsxs("button",{onClick:()=>h("staff"),className:"px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 inline-flex items-center space-x-1",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"New Staff"})]}),e.jsxs("button",{onClick:()=>h("supplier"),className:"px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50 inline-flex items-center space-x-1",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsx("span",{children:"New Supplier"})]})]})]}),e.jsxs("div",{className:"relative mt-3",children:[e.jsx(Q,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{value:f,onChange:s=>q(s.target.value),placeholder:"Search by name or email...",className:"w-full pl-9 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"})]})]}),e.jsx("div",{className:"divide-y divide-gray-100 max-h-[70vh] overflow-y-auto",children:m?e.jsx("div",{className:"p-6 text-center text-gray-500",children:"Loading..."}):O.map(s=>{const t=P(s),r=n&&s._id===n._id;return e.jsx("button",{onClick:()=>w(s),className:`w-full text-left p-3 hover:bg-gray-50 ${r?"bg-gray-50":""}`,children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(U,{name:t?.fullName||t?.email,role:t?.role}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-medium text-gray-900 truncate",children:t?.fullName||t?.email}),e.jsx("div",{className:"text-[10px] text-gray-400 ml-2 shrink-0",children:s.updatedAt&&new Date(s.updatedAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),e.jsx("div",{className:"text-xs text-gray-500 truncate",children:s.lastMessage?.text||"No messages yet"})]})]})},s._id)})})]}),e.jsx("div",{className:"bg-white rounded-2xl border border-gray-200 p-0 overflow-hidden lg:col-span-2 flex flex-col min-h-[70vh]",children:n?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"p-4 border-b bg-gradient-to-r from-white to-emerald-50",children:(()=>{const s=P(n);return e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(U,{name:s?.fullName||s?.email,role:s?.role}),e.jsxs("div",{children:[e.jsx("div",{className:"font-semibold text-gray-900",children:s?.fullName||s?.email}),e.jsxs("div",{className:"text-xs text-gray-500",children:[s?.role?s.role.charAt(0).toUpperCase()+s.role.slice(1):""," â€¢ Polling every 5s ",z?e.jsx(V,{className:"inline w-3 h-3 animate-spin ml-1"}):null]})]})]})})})()}),e.jsx("div",{ref:g,className:"flex-1 overflow-y-auto p-4 space-y-2 bg-white",children:H.map((s,t)=>{if(s.type==="day")return e.jsx("div",{className:"sticky top-0 z-10 flex justify-center my-2",children:e.jsx("span",{className:"text-[11px] font-medium text-gray-600 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200",children:s.key})},`day-${s.key}-${t}`);const r=s.data,c=String(r.sender)===String(l?._id)||String(r.sender?._id)===String(l?._id);return e.jsx("div",{className:`flex ${c?"justify-end":"justify-start"} px-1`,children:e.jsxs("div",{className:`max-w-[75%] rounded-2xl px-4 py-2 text-sm shadow ${c?"bg-emerald-600 text-white rounded-br-sm":"bg-gray-100 text-gray-900 rounded-bl-sm"}`,children:[r.text&&e.jsx("div",{className:"whitespace-pre-wrap leading-relaxed",children:r.text}),e.jsx("div",{className:`text-[10px] mt-1 ${c?"text-white/80":"text-gray-500"}`,children:se(r.createdAt)})]})},r._id)})}),e.jsx("div",{className:"p-3 border-t bg-white",children:e.jsxs("div",{className:"flex items-end space-x-2",children:[e.jsx("textarea",{value:C,onChange:s=>_(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),L())},placeholder:"Write a message...",rows:1,className:"flex-1 resize-none border rounded-lg px-3 py-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"}),e.jsxs("button",{disabled:y,onClick:L,className:`px-4 py-2 rounded-lg inline-flex items-center space-x-2 ${y?"bg-emerald-400":"bg-emerald-600 hover:bg-emerald-700"} text-white`,children:[e.jsx(X,{className:"w-4 h-4"}),e.jsx("span",{children:"Send"})]})]})})]}):e.jsx("div",{className:"flex-1 grid place-items-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx(N,{className:"w-10 h-10 mx-auto mb-2"}),e.jsx("div",{children:"Select a conversation to start chatting"})]})})}),I&&e.jsx("div",{className:"fixed inset-0 bg-black/30 grid place-items-center z-50",children:e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 w-[90vw] max-w-2xl p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(N,{className:"w-5 h-5"}),e.jsx("div",{className:"font-semibold",children:"Start a conversation"})]}),e.jsx("button",{onClick:()=>b(!1),className:"text-gray-500 hover:text-gray-700",children:"Close"})]}),e.jsxs("div",{className:"flex items-center space-x-2 mb-3",children:[e.jsxs("button",{onClick:()=>h("staff"),className:`px-3 py-1.5 border rounded-lg text-sm ${T==="staff"?"bg-gray-100":""}`,children:[e.jsx(R,{className:"inline w-4 h-4 mr-1"})," Staff"]}),e.jsxs("button",{onClick:()=>h("supplier"),className:`px-3 py-1.5 border rounded-lg text-sm ${T==="supplier"?"bg-gray-100":""}`,children:[e.jsx(E,{className:"inline w-4 h-4 mr-1"})," Supplier"]})]}),e.jsx("div",{className:"max-h-[50vh] overflow-y-auto divide-y",children:Y?e.jsx("div",{className:"p-6 text-center text-gray-500",children:"Loading..."}):W.map(s=>e.jsxs("button",{onClick:()=>B(s._id||s.id),className:"w-full text-left p-3 hover:bg-gray-50",children:[e.jsx("div",{className:"font-medium",children:s.fullName||s.name||s.email}),e.jsx("div",{className:"text-xs text-gray-500",children:s.email||""})]},s._id||s.id))})]})})]})};export{ie as default};
